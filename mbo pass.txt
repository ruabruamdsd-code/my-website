/* global __firebase_config, __app_id, __initial_auth_token */
import React, { useState, useEffect, useRef } from 'react';
import { 
  Play, CheckCircle, Lock, Shield, Award, BookOpen, User, 
  ChevronRight, Zap, Sparkles, Star, UserPlus, FileText, 
  Trash2, X, Check, Loader2, PlayCircle, Download,
  MessageCircle, Send, Bot, Clock, Image as ImageIcon, Upload,
  HelpCircle, AlertCircle, RotateCcw, Search, FileCheck, QrCode,
  BadgeCheck, Medal, Gift, LayoutDashboard, LogOut, Key, CreditCard, LogIn, ExternalLink, ShieldCheck, Copy, ArrowRight, Layers, Database,
  Calendar, Timer, Blocks, Settings, Link as LinkIcon, Save, Table
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  updateDoc, 
  doc, 
  onSnapshot, 
  query, 
  serverTimestamp,
  Timestamp
} from 'firebase/firestore';

// --- Configuration & Data ---

const defaultConfig = {
  platform_name: "EdoBlock Learning Platform",
  micro_course_title: "Microlearning Essentials",
  block_course_title: "Blockchain Credentials Fundamental",
  wallet_address: "My Portfolio",
  background_color: "#0f172a", // Dark Slate 900
  surface_color: "#1e293b", // Dark Slate 800
  text_color: "#f8fafc" // Slate 50
};

const courseData = {
  modules: [
    // --- Topic 1: Microlearning (Single Unit) ---
    { 
      id: 1, 
      course: "micro",
      title: "Microlearning: การเรียนรู้รูปแบบใหม่ในยุคดิจิทัล", 
      type: "video", 
      duration: "13.45 นาที", 
      status: "current", 
      color: "blue", 
      unit: "Microlearning",
      videoUrl: "https://www.facebook.com/plugins/video.php?href=https%3A%2F%2Fwww.facebook.com%2Fwatch%2F%3Fv%3D1970413133517494&show_text=false&t=0", 
      videoSource: "ที่มา: Facebook Watch - https://www.facebook.com/watch/?v=1970413133517494",
      description: "ทำความเข้าใจนิยามของ Microlearning การเรียนรู้แบบพอดีคำ ที่เน้นสั้น กระชับ และตรงประเด็น เหมาะสำหรับผู้เรียนในยุคดิจิทัล",
      reward: { name: "Micro Master", rank: "Gold", xp: 500, icon: "Zap", color: "from-blue-500 to-cyan-500" }
    },
    // --- Topic 2: Blockchain Credentials (Single Unit) ---
    { 
      id: 2, 
      course: "block",
      title: "Digital ID & Blockchain Credentials: ความเชื่อมั่นในโลกดิจิทัล", 
      type: "video", 
      duration: "4.31 นาที", 
      status: "current", 
      color: "emerald", 
      unit: "Blockchain",
      videoUrl: "https://www.facebook.com/plugins/video.php?href=https%3A%2F%2Fwww.facebook.com%2Fwatch%2F%3Fv%3D834132463962292&show_text=false&t=0", 
      videoSource: "ที่มา: Facebook Watch - https://www.facebook.com/watch/?v=834132463962292",
      description: "เจาะลึกเรื่อง Digital Identity และการพิสูจน์และยืนยันตัวตนทางดิจิทัล (e-KYC) ซึ่งเป็นรากฐานสำคัญของการออกใบรับรองและวุฒิการศึกษาแบบ Blockchain (Blockchain Credentials) ที่น่าเชื่อถือและตรวจสอบได้จริง",
      reward: { name: "Chain Master", rank: "Gold", xp: 500, icon: "Layers", color: "from-emerald-400 to-teal-600" }
    }
  ]
};

// --- Helper Functions ---
const getColorClasses = (colorName) => {
  const colors = { emerald: 'bg-emerald-100 text-emerald-600', violet: 'bg-violet-100 text-violet-600', rose: 'bg-rose-100 text-rose-600', orange: 'bg-orange-100 text-orange-600', slate: 'from-slate-300 to-slate-100', yellow: 'from-yellow-300 to-amber-100', gray: 'from-gray-100 to-gray-50' };
  return colors[colorName] || '';
};

const generateQuizForModule = (module) => {
  switch (module.id) {
    case 1: return [ // Microlearning Quiz (10 Questions)
      { id: 1, question: "Microlearning คืออะไร?", options: ["การเรียนหลักสูตรปริญญาตรี 4 ปี", "การเรียนรู้ผ่านเนื้อหาขนาดเล็ก สั้น กระชับ", "การเรียนรู้ผ่านกล้องจุลทรรศน์", "การเรียนเขียนโค้ดไมโครคอนโทรลเลอร์"], correct: 1 },
      { id: 2, question: "ข้อใดคือลักษณะเด่นสำคัญที่สุดของ Microlearning?", options: ["ใช้เวลาเรียนนาน", "เนื้อหายืดเยื้อ", "โฟกัสทีละหนึ่งวัตถุประสงค์การเรียนรู้ (One Concept)", "ต้องเรียนในห้องเรียนเท่านั้น"], correct: 2 },
      { id: 3, question: "อุปกรณ์ใดเหมาะสมที่สุดสำหรับการเข้าถึง Microlearning?", options: ["เครื่องฉายหนัง", "สมาร์ทโฟนหรือแท็บเล็ต", "คอมพิวเตอร์เมนเฟรม", "วิทยุ"], correct: 1 },
      { id: 4, question: "Microlearning ช่วยแก้ปัญหาอะไรของผู้เรียนในปัจจุบัน?", options: ["สมาธิสั้นและเวลาจำกัด", "สายตาสั้น", "ความหิว", "ความเหงา"], correct: 0 },
      { id: 5, question: "ความยาวที่เหมาะสมของวิดีโอ Microlearning คือเท่าใด?", options: ["60 นาที", "30 นาที", "3-7 นาที", "3 วินาที"], correct: 2 },
      { id: 6, question: "เทคนิค 'Chunking' คืออะไร?", options: ["การกินอาหารคำโตๆ", "การย่อยเนื้อหาใหญ่ออกเป็นส่วนย่อยๆ", "การทิ้งขยะ", "การรวมเนื้อหาให้ใหญ่ขึ้น"], correct: 1 },
      { id: 7, question: "ข้อใด *ไม่ใช่* ประโยชน์ของ Microlearning?", options: ["เข้าถึงง่าย (Accessible)", "ทบทวนได้บ่อย (Repeatable)", "ได้รับปริญญาเอกทันที", "ประหยัดเวลา (Time-saving)"], correct: 2 },
      { id: 8, question: "Just-in-time learning หมายถึง?", options: ["เรียนเมื่อไหร่ก็ได้ที่ต้องการใช้งานจริง", "เรียนให้ทันเวลาสอบ", "เรียนตอนเช้าเท่านั้น", "เรียนให้จบเร็วที่สุด"], correct: 0 },
      { id: 9, question: "Cognitive Load Theory เกี่ยวข้องกับ Microlearning อย่างไร?", options: ["ต้องเพิ่มภาระสมองให้มากที่สุด", "ช่วยลดภาระการประมวลผลของสมอง ทำให้จำได้ดีขึ้น", "ไม่เกี่ยวข้องกัน", "ทำให้สมองทำงานหนักจนล้า"], correct: 1 },
      { id: 10, question: "รูปแบบสื่อใดที่ *ไม่นิยม* ใช้ใน Microlearning?", options: ["วิดีโอสั้น", "อินโฟกราฟิก", "พอดแคสต์สั้นๆ", "หนังสือเล่มหนา 500 หน้า"], correct: 3 }
    ];
    case 2: return [ // Blockchain Quiz (10 Questions)
      { id: 1, question: "Blockchain เปรียบเสมือนอะไรในโลกดิจิทัล?", options: ["สมุดบัญชีสาธารณะที่ทุกคนมีสำเนาและแก้ไขไม่ได้", "โซ่คล้องจักรยาน", "โปรแกรมแต่งรูป", "เว็บไซต์ขายของ"], correct: 0 },
      { id: 2, question: "คุณสมบัติ 'Immutability' ใน Blockchain หมายถึงอะไร?", options: ["ข้อมูลเปลี่ยนแปลงได้ตลอดเวลา", "ข้อมูลลบเลือนง่าย", "ข้อมูลเมื่อบันทึกแล้ว แก้ไขหรือลบไม่ได้", "ข้อมูลเป็นความลับ"], correct: 2 },
      { id: 3, question: "Decentralized (กระจายศูนย์) ดีอย่างไร?", options: ["รวมอำนาจไว้ที่เดียว", "ไม่มีตัวกลาง ลดความเสี่ยงจากการล่มที่จุดเดียว", "ทำให้ระบบช้าลง", "ต้องขออนุญาตแอดมินทุกครั้ง"], correct: 1 },
      { id: 4, question: "ทำไม Blockchain ถึงเหมาะกับการเก็บวุฒิการศึกษา?", options: ["เพราะดูทันสมัย", "ป้องกันการปลอมแปลงวุฒิและตรวจสอบได้ง่าย", "ประหยัดหมึกพิมพ์", "สีสวยกว่ากระดาษ"], correct: 1 },
      { id: 5, question: "Digital Signature มีหน้าที่อะไรใน Digital Credential?", options: ["ไว้ประดับเพื่อความสวยงาม", "ยืนยันตัวตนผู้ออกเอกสารและรับรองความถูกต้อง", "บอกราคาวุฒิบัตร", "ใช้แทนรูปถ่ายหน้าตรง"], correct: 1 },
      { id: 6, question: "ถ้ามีคนแอบแก้ไขข้อมูลใน Block หนึ่ง จะเกิดอะไรขึ้น?", options: ["ไม่มีใครรู้", "ค่า Hash จะเปลี่ยน และระบบจะปฏิเสธข้อมูลนั้นทันที", "ข้อมูลจะถูกต้องเหมือนเดิม", "คอมพิวเตอร์จะระเบิด"], correct: 1 },
      { id: 7, question: "Smart Contract คืออะไร?", options: ["สัญญาอัจฉริยะที่ทำงานอัตโนมัติตามเงื่อนไขที่เขียนไว้", "คนฉลาด", "สัญญาจ้างงานพนักงาน", "กระดาษสัญญาธรรมดา"], correct: 0 },
      { id: 8, question: "ใครสามารถตรวจสอบความถูกต้องของข้อมูลบน Public Blockchain ได้?", options: ["เฉพาะรัฐมนตรี", "เฉพาะโปรแกรมเมอร์", "ทุกคนในเครือข่าย", "ไม่มีใครตรวจสอบได้"], correct: 2 },
      { id: 9, question: "Verifiable Credential (VC) ช่วยลดปัญหาใด?", options: ["ปัญหาการจราจร", "ปัญหาการปลอมแปลงเอกสารสำคัญ", "ปัญหาโลกร้อน", "ปัญหาขยะล้นเมือง"], correct: 1 },
      { id: 10, question: "Blockchain เป็นเทคโนโลยีพื้นฐานของสกุลเงินดิจิทัลใดเป็นสกุลแรก?", options: ["Bitcoin", "Ethereum", "Dogecoin", "US Dollar"], correct: 0 }
    ];
    default: return [];
  }
};

// --- Firebase Setup ---
const firebaseConfig = {
  apiKey: "AIzaSyArERDuS3i0AHmLdrS68tMRvilDYchld90",
  authDomain: "edoblock-51e6c.firebaseapp.com",
  projectId: "edoblock-51e6c",
  storageBucket: "edoblock-51e6c.firebasestorage.app",
  messagingSenderId: "426632152384",
  appId: "1:426632152384:web:3196962baa6364fe06a6a5",
  measurementId: "G-66Y7LXGBR2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// กัน error ของ __app_id
const appId =
  typeof __app_id !== "undefined" ? __app_id : "default-app-id";
const callGeminiAPI = async (prompt) => {
  const apiKey = ""; 
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  const payload = { contents: [{ parts: [{ text: prompt }] }] };
  try {
    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI ไม่พร้อมใช้งาน";
  } catch (error) { return "เกิดข้อผิดพลาดในการเชื่อมต่อ AI"; }
};

// --- Custom Logo Component ---
const Logo = ({ size = "large", theme = "dark" }) => {
  const isLarge = size === "large";
  const isDarkTheme = theme === "dark";
  const textColor = isDarkTheme ? "text-white" : "text-purple-900";
  const subTextColor = isDarkTheme ? "text-slate-400" : "text-purple-600";
   
  return (
    <div className="flex flex-col items-center">
      <div className="relative">
        <div className={`absolute inset-0 bg-gradient-to-r from-blue-600 to-emerald-600 blur-2xl opacity-40 rounded-full ${isLarge ? 'w-32 h-32' : 'w-20 h-20'}`}></div>
        <div className={`relative flex items-center justify-center bg-gradient-to-br ${isDarkTheme ? 'from-slate-800 to-slate-950 border-slate-700' : 'from-white to-purple-50 border-purple-200'} border shadow-2xl ${isLarge ? 'w-32 h-32 rounded-3xl' : 'w-20 h-20 rounded-2xl'}`}>
          <div className="absolute top-2 right-2 w-2 h-2 bg-emerald-500 rounded-full animate-ping"></div>
          <div className="absolute bottom-2 left-2 w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
          <div className="relative z-10 flex items-center justify-center">
             <div className="absolute">
                <Layers size={isLarge ? 64 : 40} className={isDarkTheme ? "text-slate-700" : "text-purple-200"} style={isDarkTheme ? {} : { transform: 'rotate(12deg) scale(1.1)' }} />
             </div>
             <ShieldCheck size={isLarge ? 56 : 36} className={`text-transparent ${isDarkTheme ? 'fill-emerald-500' : 'fill-purple-600'} drop-shadow-md relative z-20`} />
          </div>
        </div>
      </div>
      <div className={`mt-4 text-center ${isLarge ? 'space-y-2' : 'space-y-1'}`}>
         <h1 className={`${isLarge ? 'text-5xl' : 'text-3xl'} font-black tracking-tighter ${textColor}`}>
           <span className={isDarkTheme ? "text-blue-500" : "text-purple-700"}>Edo</span>
           <span className={isDarkTheme ? "text-emerald-500" : "text-purple-500"}>Block</span>
         </h1>
         <p className={`${isLarge ? 'text-sm' : 'text-[10px]'} font-bold ${subTextColor} tracking-[0.3em] uppercase`}>
           Learning Platform
         </p>
      </div>
    </div>
  );
};

// --- Components (Defined BEFORE App) ---

const Toast = ({ message, type, onClose }) => {
  useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
  return <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[200] px-6 py-3 rounded-xl font-bold text-sm shadow-lg animate-bounce-in ${type === 'error' ? 'bg-red-500 text-white' : 'bg-emerald-500 text-white'}`}>{message}</div>;
};

const ConfettiPiece = ({ color, left, animationDuration, animationDelay }) => (
  <div className="confetti-piece fixed w-2.5 h-2.5 z-[9999]" style={{ backgroundColor: color, left: `${left}%`, animation: `confetti-fall ${animationDuration}s linear forwards`, animationDelay: `${animationDelay}s` }} />
);

const RewardModal = ({ reward, onClose }) => (
  <div className="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
    <div className="bg-slate-900 rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl relative text-center p-8 animate-bounce-in border border-slate-700">
      <div className="relative z-10">
        <h2 className="text-2xl font-black text-white mb-2">ยินดีด้วย!</h2>
        <p className="text-slate-400 mb-6">คุณได้รับเหรียญรางวัลใหม่</p>
        <div className={`w-32 h-32 mx-auto rounded-full bg-gradient-to-br ${reward.color} flex items-center justify-center shadow-lg mb-6 ring-4 ring-slate-800`}>
          {reward.icon === 'Shield' && <Shield size={64} className="text-white" />}
          {reward.icon === 'Zap' && <Zap size={64} className="text-white" />}
          {reward.icon === 'Lock' && <Lock size={64} className="text-white" />}
          {reward.icon === 'User' && <User size={64} className="text-white" />}
          {reward.icon === 'FileText' && <FileText size={64} className="text-white" />}
          {reward.icon === 'BookOpen' && <BookOpen size={64} className="text-white" />}
          {reward.icon === 'Settings' && <ArrowRight size={64} className="text-white" />}
          {reward.icon === 'Star' && <Star size={64} className="text-white" />}
          {reward.icon === 'Blocks' && <Blocks size={64} className="text-white" />}
          {reward.icon === 'BadgeCheck' && <BadgeCheck size={64} className="text-white" />}
          {reward.icon === 'Database' && <Database size={64} className="text-white" />}
          {reward.icon === 'Award' && <Award size={64} className="text-white" />}
          {reward.icon === 'ShieldCheck' && <ShieldCheck size={64} className="text-white" />}
          {reward.icon === 'Layers' && <Layers size={64} className="text-white" />}
        </div>
        <div className="bg-slate-800 rounded-xl p-3 mb-6 border border-slate-700"><h3 className="text-xl font-black text-white">{reward.name}</h3></div>
        <button onClick={onClose} className="w-full bg-gradient-to-r from-blue-600 to-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:brightness-110 transition-all">เก็บใส่กระเป๋า</button>
      </div>
    </div>
  </div>
);

const QuizModal = ({ module, onClose, onPass }) => {
  const [questions, setQuestions] = useState([]);
  const [idx, setIdx] = useState(0);
  const [answers, setAnswers] = useState({});
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [score, setScore] = useState(0);
  useEffect(() => { setQuestions(generateQuizForModule(module)); }, [module]);
   
  const handleAnswer = (optionIdx) => { if (!isSubmitted) setAnswers(prev => ({ ...prev, [idx]: optionIdx })); };
  const handleSubmit = () => {
    let s = 0; questions.forEach((q, i) => { if (answers[i] === q.correct) s++; });
    setScore(s); setIsSubmitted(true);
  };
   
  if (!questions.length) return <div className="text-white text-center p-10">Loading Quiz...</div>;
  const isPassed = score >= 7; // Update pass mark to 7/10

  return (
    <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in">
      <div className="bg-slate-900 rounded-3xl w-full max-w-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh] border border-slate-700">
        <div className={`bg-gradient-to-r ${module.course === 'micro' ? 'from-blue-600 to-cyan-600' : 'from-emerald-600 to-teal-600'} p-6 text-white flex justify-between items-center`}>
          <div>
            <h3 className="text-sm font-bold opacity-80 uppercase tracking-wider">{module.unit}</h3>
            <h2 className="font-black text-2xl">แบบทดสอบ</h2>
          </div>
          {!isSubmitted && <div className="bg-black/30 px-3 py-1 rounded-lg text-sm font-bold">ข้อที่ {idx + 1}/{questions.length}</div>}
        </div>
        <div className="p-6 overflow-y-auto flex-1">
          {isSubmitted ? (
            <div className="text-center py-8">
               <div className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-6 shadow-xl ${isPassed ? 'bg-emerald-500/20 text-emerald-500' : 'bg-red-500/20 text-red-500'}`}>
                 {isPassed ? <Award size={48}/> : <AlertCircle size={48}/>}
               </div>
               <h3 className="text-3xl font-black mb-2 text-white">{isPassed ? "ผ่านแล้ว!" : "พยายามอีกนิด"}</h3>
               <div className="text-6xl font-black mb-6 text-white">{score}/{questions.length}</div>
               <p className="text-slate-400 mb-8">เกณฑ์การผ่าน: 70% (7 คะแนน)</p>
               {isPassed ? <button onClick={onPass} className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg shadow-emerald-900/50">บันทึกผล & รับเหรียญ</button> : <button onClick={() => { setIsSubmitted(false); setScore(0); setAnswers({}); setIdx(0); }} className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-xl font-bold transition-all">ลองใหม่</button>}
            </div>
          ) : (
            <div>
              <h3 className="text-xl font-bold mb-6 text-white leading-relaxed">{questions[idx].question}</h3>
              <div className="space-y-3">
                {questions[idx].options.map((opt, i) => (
                  <button key={i} onClick={() => handleAnswer(i)} className={`w-full text-left p-4 rounded-xl border-2 transition-all ${answers[idx] === i ? 'border-blue-500 bg-blue-500/10 text-blue-400' : 'border-slate-700 bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>{opt}</button>
                ))}
              </div>
            </div>
          )}
        </div>
        {!isSubmitted && (
          <div className="p-4 border-t border-slate-800 flex justify-between bg-slate-900">
            <button onClick={() => setIdx(prev => Math.max(0, prev - 1))} disabled={idx === 0} className="px-4 py-2 text-slate-500 hover:text-white disabled:opacity-30">ย้อนกลับ</button>
            {idx === questions.length - 1 ? <button onClick={handleSubmit} disabled={Object.keys(answers).length < questions.length} className="bg-gradient-to-r from-blue-600 to-emerald-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">ส่งคำตอบ</button> : <button onClick={() => setIdx(prev => prev + 1)} className="bg-slate-700 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-600">ถัดไป</button>}
          </div>
        )}
      </div>
    </div>
  );
};

const VideoModal = ({ module, onClose, onVideoFinish, onAskAI }) => (
  <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in">
    <div className="bg-slate-900 rounded-3xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh] border border-slate-700">
      <div className="relative aspect-video bg-black w-full">
        <iframe 
          src={module.videoUrl} 
          className="w-full h-full" 
          frameBorder="0" 
          allowFullScreen
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          scrolling="no"
        ></iframe>
        <button onClick={onClose} className="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full hover:bg-white/20 transition-all"><X size={20}/></button>
      </div>
      <div className="p-6 overflow-y-auto bg-slate-900">
        <div className="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
            {/* Buttons Block - Reordered to be on top for mobile, right side for desktop */}
            <div className="w-full md:w-64 space-y-3 shrink-0 order-1 md:order-2">
              <button onClick={() => onVideoFinish(module)} className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-blue-600 to-emerald-600 text-white hover:brightness-110 transition-all shadow-lg flex items-center justify-center gap-2">
                <CheckCircle size={20}/> เรียนจบแล้ว (สอบ)
              </button>
              <button onClick={() => onAskAI(module)} className="w-full py-3 rounded-xl font-bold border border-slate-700 text-slate-300 hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                <Sparkles size={18} className="text-yellow-400"/> AI สรุปบทเรียน
              </button>
            </div>

            {/* Description Block */}
            <div className="flex-1 order-2 md:order-1">
                <div className="flex gap-2 mb-3">
                   <span className="bg-blue-900/50 text-blue-400 px-3 py-1 rounded-full text-xs font-bold border border-blue-800">{module.unit}</span>
                   <span className="bg-emerald-900/50 text-emerald-400 px-3 py-1 rounded-full text-xs font-bold border border-emerald-800">{module.duration}</span>
                </div>
                <h3 className="text-xl font-black mb-2 text-white">{module.title}</h3>
                <p className="text-slate-400 text-sm mb-4 leading-relaxed">{module.description}</p>
                <div className="mb-6 text-xs text-slate-500 bg-slate-800 p-3 rounded-xl border border-slate-700 flex items-start gap-2">
                  <ExternalLink size={14} className="mt-0.5 flex-shrink-0" />
                  <span>{module.videoSource}</span>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
);

const AIChatWindow = ({ isOpen, onClose, initialQuery, onClear }) => {
  const [msgs, setMsgs] = useState([{ role: 'bot', text: 'สวัสดีครับ EdoBot พร้อมช่วยตอบคำถามเกี่ยวกับบทเรียนครับ' }]);
  const [txt, setTxt] = useState('');
  const [load, setLoad] = useState(false);
  const endRef = useRef(null);
   
  useEffect(() => { if (isOpen && initialQuery) { handleSend(initialQuery); onClear(); } }, [isOpen, initialQuery]);
  useEffect(() => { endRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [msgs]);
   
  const handleSend = async (t = txt) => {
    if (!t.trim() || load) return;
    setMsgs(p => [...p, { role: 'user', text: t }]);
    setTxt(''); setLoad(true);
    const res = await callGeminiAPI(t);
    setMsgs(p => [...p, { role: 'bot', text: res }]);
    setLoad(false);
  };
   
  if (!isOpen) return null;
  return (
    <div className="fixed bottom-24 right-4 w-80 h-96 bg-slate-900 rounded-2xl shadow-2xl z-[160] flex flex-col border border-slate-700 overflow-hidden">
      <div className="bg-slate-800 p-4 text-white flex justify-between items-center border-b border-slate-700">
        <div className="flex items-center gap-2"><Bot size={18} className="text-emerald-400"/> <span className="font-bold">EdoBot AI</span></div>
        <button onClick={onClose} className="hover:text-red-400"><X size={18}/></button>
      </div>
      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900">
        {msgs.map((m, i) => (
          <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`p-3 rounded-xl text-sm max-w-[85%] ${m.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-tl-none'}`}>
              {m.text}
            </div>
          </div>
        ))}
        {load && <div className="text-xs text-slate-500 animate-pulse">EdoBot is typing...</div>}
        <div ref={endRef} />
      </div>
      <div className="p-3 border-t border-slate-700 bg-slate-800 flex gap-2">
        <input value={txt} onChange={e => setTxt(e.target.value)} className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 text-sm text-white focus:outline-none focus:border-blue-500" placeholder="พิมพ์คำถาม..." onKeyPress={(e) => e.key === 'Enter' && handleSend()} />
        <button onClick={() => handleSend()} className="bg-blue-600 text-white p-2 rounded-xl hover:bg-blue-500"><Send size={18}/></button>
      </div>
    </div>
  );
};

const CertificateModal = ({ profile, type, onClose, onDownload }) => {
  const [scale, setScale] = useState(1);
  const containerRef = useRef(null);
  const today = new Date().toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  const displayCertId =
    type === 'micro'
      ? profile.cert_micro_id
      : profile.cert_block_id;

  const courseTitle =
    type === 'micro'
      ? defaultConfig.micro_course_title
      : defaultConfig.block_course_title;

    useEffect(() => {
    const handleResize = () => {
        if (containerRef.current) {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const certWidth = 1123;
            const certHeight = 794;
            
            // Padding
            const padding = 40; 
            const availableWidth = screenWidth - padding;
            const availableHeight = screenHeight - 150; // Reserve space for buttons

            const scaleX = availableWidth / certWidth;
            const scaleY = availableHeight / certHeight;
            
            // Choose the smaller scale to fit entirely
            const newScale = Math.min(scaleX, scaleY, 0.8); // Max scale 0.8 for aesthetics
            setScale(newScale);
        }
    };

  if (!profile) return null;
  const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
  const displayCertId = type === 'micro' ? profile.cert_micro_id : profile.cert_block_id;
  const courseTitle = type === 'micro' ? defaultConfig.micro_course_title : defaultConfig.block_course_title;

  // Responsive Scaling Logic

    handleResize(); // Initial call
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return (
    <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/90 backdrop-blur-md animate-fade-in">
      {/* Container to hold the scaled certificate */}
      <div ref={containerRef} className="relative flex flex-col items-center justify-center w-full h-full p-4">
        
        {/* Certificate Display Wrapper */}
        <div style={{ width: 1123 * scale, height: 794 * scale }} className="relative shadow-2xl mb-6">
            <div style={{ transform: `scale(${scale})`, transformOrigin: 'top left', width: '1123px', height: '794px' }}>
                <div id="certificate-capture" className="relative bg-white text-slate-900 mx-auto overflow-hidden shadow-2xl font-['Sarabun']" style={{ width: '1123px', height: '794px', minWidth: '1123px', minHeight: '794px', fontFamily: "'Sarabun', sans-serif" }}>
                  
                  {/* --- Background Elements --- */}
                  {/* Removed complex radial-gradient to fix html2canvas crash */}
                  <div className="absolute inset-0 flex items-center justify-center">
                      <div className="w-[600px] h-[600px] bg-purple-100 rounded-full blur-[100px] opacity-30"></div>
                  </div>

                  {/* --- Borders & Frame --- */}
                  <div className="absolute inset-4 border border-slate-300"></div>
                  <div className="absolute inset-6 border-[6px] border-purple-900"></div>
                  <div className="absolute inset-9 border border-slate-300"></div>
                  
                  {/* Corner Ornaments */}
                  <div className="absolute top-6 left-6 w-24 h-24 border-t-[6px] border-l-[6px] border-purple-900"></div>
                  <div className="absolute top-6 right-6 w-24 h-24 border-t-[6px] border-r-[6px] border-purple-900"></div>
                  <div className="absolute bottom-6 left-6 w-24 h-24 border-b-[6px] border-l-[6px] border-purple-900"></div>
                  <div className="absolute bottom-6 right-6 w-24 h-24 border-b-[6px] border-r-[6px] border-purple-900"></div>

                  {/* --- Content Container --- */}
                  <div className="relative z-10 h-full flex flex-col items-center justify-between py-16 px-24 text-center">
                    
                    {/* Header */}
                    <div className="flex flex-col items-center">
                        <div className="mb-4 transform scale-90">
                           <Logo size="large" theme="light" />
                        </div>
                        <h1 className="text-5xl font-bold tracking-[0.15em] text-purple-900 uppercase font-['Sarabun'] drop-shadow-sm">Certificate of Completion</h1>
                        <p className="text-lg text-slate-500 mt-3 font-medium tracking-wider uppercase">This certificate is proudly presented to</p>
                    </div>

                    {/* Recipient Name */}
                    <div className="w-full flex flex-col items-center">
                        <h2 className="text-6xl font-bold text-slate-800 mb-2 leading-tight font-['Sarabun'] px-8">{profile.full_name}</h2>
                        <div className="w-2/3 h-px bg-gradient-to-r from-transparent via-slate-400 to-transparent mt-2"></div>
                    </div>

                    {/* Course Info */}
                    <div className="w-full px-16">
                        <p className="text-xl text-slate-600 mb-3 italic">For successfully completing the course</p>
                        <h3 className="text-4xl font-black text-purple-800 font-['Sarabun'] leading-relaxed tracking-tight py-2">"{courseTitle}"</h3>
                        <p className="text-slate-500 text-sm mt-2 max-w-2xl mx-auto">Demonstrating dedication and commitment to continuous learning and professional development.</p>
                    </div>

                    {/* Footer: Date & Signature */}
                    <div className="w-full flex justify-between items-end px-16 mt-4">
                      <div className="flex flex-col items-center w-64">
                        <div className="text-xl font-bold text-slate-700 border-b-2 border-slate-300 w-full pb-2 mb-2">{today}</div>
                        <p className="text-xs text-purple-900 font-bold uppercase tracking-[0.2em]">Date Issued</p>
                      </div>
                      <div className="flex flex-col items-center w-80 relative">
                        <div className="absolute -top-10 left-0 right-0 text-center transform -rotate-2">
                            <span className="font-['Great_Vibes'] text-5xl text-purple-800 opacity-90">Sutithep S.</span>
                        </div>
                        <div className="mt-6 border-b-2 border-slate-300 w-full pb-2 mb-2"></div>
                        <p className="text-sm font-bold text-slate-900">รศ.ดร.สูติเทพ ศิริพิพัฒนกุล</p>
                        <p className="text-[10px] text-slate-500 mt-0.5">ภาควิชาเทคโนโลยีการศึกษา คณะศึกษาศาสตร์</p>
                        <p className="text-[10px] text-slate-500">มหาวิทยาลัยเกษตรศาสตร์</p>
                      </div>
                    </div>
                  </div>

                  {/* Ref ID & QR - Bottom Right */}
                  <div className="absolute bottom-12 right-12 flex flex-col items-end z-20">
                      <div className="bg-white p-1.5 rounded-lg shadow-sm border border-purple-100 mb-1">
                          <QrCode size={42} className="text-purple-900" />
                      </div>
                      <div className="text-right bg-white/90 backdrop-blur-sm px-3 py-1 rounded border border-purple-50 shadow-sm">
                          <span className="block text-[8px] text-purple-400 font-bold uppercase tracking-wider mb-0.5 leading-none">Certificate Ref.</span>
                          <span className="block text-[11px] text-purple-900 font-bold font-mono tracking-widest leading-none">{displayCertId || "PENDING"}</span>
                      </div>
                  </div>

                </div>
            </div>
        </div>
        
        {/* Controls - Mobile Friendly */}
        <div className="flex gap-4 w-full justify-center max-w-md">
           <button onClick={onDownload} className="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-full font-bold shadow-lg transition-all flex items-center justify-center gap-2 text-sm"><Download size={18} /> บันทึกรูป</button>
           <button onClick={onClose} className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-3 rounded-full font-bold border border-slate-600 transition-all text-sm">ปิด</button>
        </div>
      </div>
    </div>
  );
};

const AuthHeader = () => (
  <div className="text-center mb-8 relative z-10">
     <Logo size="normal" />
  </div>
);

const LandingPage = ({ onStart }) => (
  <div className="flex flex-col items-center justify-center min-h-[80vh] p-8 text-center animate-fade-in space-y-6">
    <div className="absolute inset-0 overflow-hidden pointer-events-none">
       <div className="absolute top-1/4 left-1/4 w-72 h-72 bg-blue-500/20 rounded-full blur-[100px] animate-blob"></div>
       <div className="absolute bottom-1/4 right-1/4 w-72 h-72 bg-emerald-500/20 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
    </div>
    <div className="relative z-10 transform hover:scale-105 transition-transform duration-500">
       <Logo size="large" />
    </div>
    <p className="text-gray-400 max-w-xs leading-relaxed font-medium">
      แพลตฟอร์มการเรียนรู้ สำหรับทุกคน<br/>เรียนรู้ได้ทุกที่ ทุกเวลา เรียนสั้น ตรวจสอบได้
    </p>
    <button onClick={onStart} className="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:bg-blue-700 transition-all active:scale-95 flex items-center gap-2 group">
      <span>เริ่มต้นใช้งาน</span>
      <ArrowRight className="group-hover:translate-x-1 transition-transform" />
    </button>
  </div>
);

const ExpiryModal = ({ user, onClose, onSave }) => {
  const [date, setDate] = useState('');
   
  useEffect(() => {
    if (user?.access_expiry) {
       const d = new Date(user.access_expiry.seconds * 1000);
       const offset = d.getTimezoneOffset() * 60000;
       const localISOTime = (new Date(d - offset)).toISOString().slice(0, 16);
       setDate(localISOTime);
    }
  }, [user]);

  return (
    <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
       <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-full max-w-sm shadow-2xl">
         <h3 className="text-white font-bold text-lg mb-2 flex items-center gap-2"><Clock size={20} className="text-blue-400"/> ตั้งเวลาหมดอายุการใช้งาน</h3>
         <p className="text-slate-400 text-sm mb-6">ผู้ใช้งาน: <span className="text-white font-bold">{user.full_name}</span></p>
         <input 
           type="datetime-local" 
           value={date} 
           onChange={(e) => setDate(e.target.value)}
           className="w-full bg-slate-800 text-white border border-slate-600 rounded-xl p-3 mb-6 focus:border-blue-500 focus:outline-none transition-colors"
         />
         <div className="flex flex-col gap-2">
            <button onClick={() => onSave(date)} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-all">บันทึกเวลา</button>
            <button onClick={() => onSave(null)} className="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 py-3 rounded-xl font-bold transition-all">ยกเลิกจำกัดเวลา</button>
            <button onClick={onClose} className="w-full text-slate-500 hover:text-white py-2 text-sm">ปิด</button>
         </div>
       </div>
    </div>
  );
};

// --- Sub-View Components (Defined BEFORE App) ---

const LearnView = ({ isProfileLoading, isRegistered, handleGoToRegister, completedModules, openModuleVideo, setShowCertificate, currentUserProfile, setCertType, isAccessExpired, issueCertificate, onOpenQuiz }) => {
  if (isProfileLoading) return <div className="flex justify-center items-center h-[80vh] flex-col gap-4 animate-fade-in"><Loader2 className="animate-spin text-blue-500" size={48} /><p className="text-slate-400 font-medium">Loading Course...</p></div>;
  if (!isRegistered) return <LandingPage onStart={handleGoToRegister} />;
   
  if (isAccessExpired) {
      return (
           <div className="flex flex-col items-center justify-center min-h-[70vh] p-8 text-center animate-fade-in">
              <div className="bg-red-500/10 p-8 rounded-full mb-6 animate-pulse">
                 <Timer size={64} className="text-red-500" />
              </div>
              <h2 className="text-3xl font-black text-white mb-2">หมดเวลาการใช้งาน</h2>
              <p className="text-slate-400 max-w-md mx-auto mb-8 font-medium">
                 บัญชีผู้ใช้งานของคุณสิ้นสุดระยะเวลาการเข้าถึงเนื้อหาแล้ว<br/>กรุณาติดต่อผู้ดูแลระบบเพื่อต่ออายุ
              </p>
           </div>
      );
  }

  const microModules = courseData.modules.filter(m => m.course === 'micro');
  const blockModules = courseData.modules.filter(m => m.course === 'block');

  const microCompletedCount = completedModules.filter(id => microModules.some(m => m.id === id)).length;
  const blockCompletedCount = completedModules.filter(id => blockModules.some(m => m.id === id)).length;

  const microProgress = Math.round((microCompletedCount / microModules.length) * 100);
  const blockProgress = Math.round((blockCompletedCount / blockModules.length) * 100);

  const renderModuleCard = (module, isCompleted, isUnlock) => (
    <div key={module.id} className={`group relative overflow-hidden rounded-2xl p-1 transition-all hover:scale-[1.01] ${isUnlock ? 'bg-gradient-to-br from-slate-700 to-slate-800' : 'bg-slate-900 opacity-60'}`}>
       <div className={`absolute inset-0 bg-gradient-to-r ${module.color === 'blue' ? 'from-blue-500/20 to-cyan-500/20' : 'from-emerald-500/20 to-teal-500/20'} opacity-0 group-hover:opacity-100 transition-opacity`}></div>
       <div className="bg-slate-900 rounded-xl p-4 h-full border border-slate-800 relative z-10 flex items-center gap-4">
          <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${isCompleted ? (module.color === 'blue' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400') : isUnlock ? 'bg-slate-700 text-white' : 'bg-slate-800 text-slate-600'}`}>
            {isCompleted ? <CheckCircle size={24} /> : isUnlock ? <Play size={24} className="ml-1" /> : <Lock size={24} />}
          </div>
          <div className="flex-1 min-w-0">
            <h4 className={`font-bold text-sm mb-1 ${isUnlock ? 'text-white' : 'text-slate-500'} line-clamp-2`}>{module.title}</h4>
            <div className="flex items-center gap-3 text-xs text-slate-400">
              <span className="flex items-center gap-1"><Clock size={10} /> {module.duration}</span>
            </div>
          </div>
          {isUnlock && (
            <div className="flex flex-col sm:flex-row gap-2 shrink-0">
                <button onClick={() => openModuleVideo(module)} className="bg-slate-800 hover:bg-slate-700 text-slate-300 p-3 rounded-xl transition-colors border border-slate-700 flex items-center gap-2 text-xs font-bold" title="ดูวิดีโอ">
                  {isCompleted ? <RotateCcw size={18}/> : <PlayCircle size={18}/>}
                  <span className="hidden sm:inline">วิดีโอ</span>
                </button>
                <button onClick={() => onOpenQuiz(module)} className="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl transition-colors border border-blue-500 shadow-lg shadow-blue-900/20 flex items-center gap-2 text-xs font-bold" title="ทำแบบทดสอบ">
                  <FileText size={18}/>
                  <span className="hidden sm:inline">แบบทดสอบ</span>
                </button>
            </div>
          )}
       </div>
    </div>
  );
   
  return (
    <div className="p-5 pb-32 space-y-8 animate-fade-in relative z-10 max-w-7xl mx-auto">
      {/* Microlearning Section */}
      <div>
        <div className="flex items-center justify-between mb-4">
             <h3 className="text-xl font-black text-blue-400 flex items-center gap-2"><Zap size={24}/> Microlearning</h3>
             <span className="text-xs font-bold bg-blue-900/50 text-blue-300 px-3 py-1 rounded-full border border-blue-800">{microProgress}% Complete</span>
        </div>
        <div className="w-full bg-slate-800 rounded-full h-2 mb-6"><div className="bg-blue-500 h-2 rounded-full transition-all duration-1000" style={{width: `${microProgress}%`}}></div></div>
        
        {/* Grid Layout for Responsiveness */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {microModules.map(m => renderModuleCard(m, completedModules.includes(m.id), completedModules.includes(m.id) || m.id === 1 || completedModules.includes(m.id-1)))}
        </div>
        
        {(microProgress === 100 || currentUserProfile?.cert_micro_id) && (
           <button onClick={() => { 
               setCertType('micro'); 
               if (!currentUserProfile?.cert_micro_id) issueCertificate('micro');
               setShowCertificate(true); 
            }} className="w-full md:w-auto md:px-8 mt-6 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 transition-all mx-auto shadow-xl shadow-blue-900/40 border border-blue-400/20">
             <Award size={24} /> {currentUserProfile?.cert_micro_id ? "ดูเกียรติบัตร Microlearning" : "รับเกียรติบัตร Microlearning"}
           </button>
        )}
      </div>

      {/* Blockchain Section */}
      <div>
        <div className="flex items-center justify-between mb-4">
             <h3 className="text-xl font-black text-emerald-400 flex items-center gap-2"><Layers size={24}/> Blockchain Credentials</h3>
             <span className="text-xs font-bold bg-emerald-900/50 text-emerald-300 px-3 py-1 rounded-full border border-emerald-800">{blockProgress}% Complete</span>
        </div>
         <div className="w-full bg-slate-800 rounded-full h-2 mb-6"><div className="bg-emerald-500 h-2 rounded-full transition-all duration-1000" style={{width: `${blockProgress}%`}}></div></div>

        {/* Grid Layout */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {blockModules.map(m => renderModuleCard(m, completedModules.includes(m.id), completedModules.includes(m.id) || (m.id === 4 && completedModules.includes(3)) || completedModules.includes(m.id-1)))}
        </div>

        {(blockProgress === 100 || currentUserProfile?.cert_block_id) && (
           <button onClick={() => { 
               setCertType('block'); 
               if (!currentUserProfile?.cert_block_id) issueCertificate('block');
               setShowCertificate(true); 
           }} className="w-full md:w-auto md:px-8 mt-6 bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 transition-all mx-auto shadow-xl shadow-emerald-900/40 border border-emerald-400/20">
             <Award size={24} /> {currentUserProfile?.cert_block_id ? "ดูเกียรติบัตร Blockchain" : "รับเกียรติบัตร Blockchain"}
           </button>
        )}
      </div>
    </div>
  );
};

const WalletView = ({ isProfileLoading, isRegistered, handleGoToRegister, totalXP, completedModules }) => {
  if (isProfileLoading) return <div className="flex justify-center items-center h-[80vh] flex-col gap-4 animate-fade-in"><Loader2 className="animate-spin text-blue-500" size={48} /><p className="text-slate-400 font-medium">กำลังโหลดข้อมูล...</p></div>;
  if (!isRegistered) return <LandingPage onStart={handleGoToRegister} />;
  return (
  <div className="p-5 pb-32 space-y-6 animate-fade-in relative z-10 max-w-7xl mx-auto">
    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-xl border border-slate-700">
      <div className="flex justify-between items-start mb-6">
        <div>
           <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wider">Digital Portfolio</p>
           <p className="text-2xl font-black">{defaultConfig.wallet_address}</p>
        </div>
        <div className="bg-white/10 backdrop-blur-sm p-3 rounded-xl border border-white/20"><Shield size={24} /></div>
      </div>
      <div className="bg-black/30 backdrop-blur-sm rounded-2xl p-4 border border-white/10 flex justify-between items-center">
        <div>
           <p className="text-slate-400 text-xs font-bold mb-1">Total XP Earned</p>
           <p className="text-3xl font-black text-emerald-400">{totalXP} XP</p>
        </div>
        <div className="h-10 w-10 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-400"><Zap size={20}/></div>
      </div>
    </div>

    <div className="space-y-4">
      <h3 className="text-lg font-black text-white px-1 flex items-center gap-2"><Gift size={20} className="text-purple-400" /><span>My Collections</span></h3>
      {/* Grid Layout for Wallet Items */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {courseData.modules.map((module) => {
            const isUnlocked = completedModules.includes(module.id);
            const reward = module.reward;
            return (
            <div key={module.id} className={`group relative bg-slate-900 rounded-2xl p-4 shadow-sm border border-slate-800 transition-all ${isUnlocked ? 'opacity-100 hover:border-slate-600' : 'opacity-50 grayscale'}`}>
                {isUnlocked && <div className={`absolute inset-0 bg-gradient-to-br ${reward.color} opacity-5 rounded-2xl pointer-events-none`}></div>}
                <div className="flex items-center gap-4 relative z-10">
                <div className={`w-16 h-16 rounded-2xl shrink-0 flex items-center justify-center shadow-lg bg-gradient-to-br ${reward.color} text-white ring-2 ring-slate-800`}>
                    {reward.icon === 'Shield' && <Shield size={28} />}
                    {reward.icon === 'Zap' && <Zap size={28} />}
                    {reward.icon === 'Lock' && <Lock size={28} />}
                    {reward.icon === 'User' && <User size={28} />}
                    {reward.icon === 'FileText' && <FileText size={28} />}
                    {reward.icon === 'BookOpen' && <BookOpen size={28} />}
                    {reward.icon === 'Settings' && <ArrowRight size={28} />}
                    {reward.icon === 'Star' && <Star size={28} />}
                    {reward.icon === 'Blocks' && <Blocks size={28} />}
                    {reward.icon === 'BadgeCheck' && <BadgeCheck size={28} />}
                    {reward.icon === 'Database' && <Database size={28} />}
                    {reward.icon === 'Award' && <Award size={28} />}
                    {reward.icon === 'ShieldCheck' && <ShieldCheck size={28} />}
                    {reward.icon === 'Layers' && <Layers size={28} />}
                </div>
                <div className="flex-1 min-w-0">
                    <div className="flex justify-between items-start mb-1">
                        <h4 className="font-bold text-white text-base truncate pr-2">{reward.name}</h4>
                        {isUnlocked ? <div className="bg-emerald-500/20 text-emerald-400 p-1 rounded-full"><Check size={12} strokeWidth={4} /></div> : <div className="bg-slate-800 text-slate-600 p-1 rounded-full"><Lock size={12} /></div>}
                    </div>
                    <div className="flex items-center gap-3 text-xs">
                        <span className={`font-bold ${isUnlocked ? 'text-transparent bg-clip-text bg-gradient-to-r ' + reward.color : 'text-slate-500'}`}>{reward.rank}</span>
                        <span className="w-1 h-1 bg-slate-600 rounded-full"></span>
                        <span className="text-slate-400">{reward.xp} XP</span>
                    </div>
                </div>
                </div>
            </div>
            );
        })}
      </div>
    </div>
  </div>
);
};

const ProfileView = ({ isRegistered, currentUserProfile, handleUserLogout, isRegistering, isLoginMode, handleUserLogin, setIsLoginMode, setIsRegistering, handleRegister, showSuccessMessage, avatarBase64, handleFileChange, isLoading, profiles, handleDeleteProfile, setShowCertificate, setCertType }) => {
  if (isRegistered) {
    return (
      <div className="p-5 pb-32 animate-fade-in relative z-10 max-w-4xl mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-black text-white">ข้อมูลส่วนตัว</h2>
          <button onClick={handleUserLogout} className="text-red-400 bg-red-900/20 hover:bg-red-900/40 px-4 py-2 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 border border-red-900/30"><LogOut size={18} /><span>ออกจากระบบ</span></button>
        </div>
        <div className="bg-slate-900/80 backdrop-blur-md rounded-3xl p-6 shadow-xl border border-slate-700 relative overflow-hidden">
          <div className="flex flex-col md:flex-row items-center md:items-start gap-6 mb-6 relative z-10">
            <div className="w-24 h-24 rounded-full border-4 border-slate-700 shadow-lg overflow-hidden bg-slate-800 shrink-0"><img src={currentUserProfile.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserProfile.full_name)}&background=random`} alt="Profile" className="w-full h-full object-cover" /></div>
            <div className="text-center md:text-left flex-1">
                <h3 className="font-black text-2xl text-white">{currentUserProfile.full_name}</h3>
                <p className="text-slate-400">{currentUserProfile.institution}</p>
                <div className="flex items-center justify-center md:justify-start gap-1 mt-2 text-xs font-bold text-blue-300 bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-800/50 inline-flex">
                    <CreditCard size={12} /> ID: {currentUserProfile.id_card}
                </div>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm relative z-10">
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-slate-500 text-xs font-bold mb-1">ตำแหน่ง</p><p className="font-bold text-slate-200">{currentUserProfile.position}</p></div>
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-slate-500 text-xs font-bold mb-1">สาขา</p><p className="font-bold text-slate-200 truncate">{currentUserProfile.department}</p></div>
            <div className="bg-slate-800 p-4 rounded-xl md:col-span-2 border border-slate-700"><p className="text-slate-500 text-xs font-bold mb-1">อีเมล</p><p className="font-bold text-slate-200">{currentUserProfile.email}</p></div>
          </div>
        </div>
        
        <div className="mt-8 space-y-4">
            <h3 className="text-lg font-black text-white px-1">เกียรติบัตรของฉัน</h3>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Microlearning Certificate */}
                {currentUserProfile.cert_micro_id ? (
                    <div className="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-2xl p-4 shadow-lg border border-white/10 text-white flex items-center justify-between cursor-pointer hover:scale-[1.02] transition-transform group" onClick={() => { setCertType('micro'); setShowCertificate(true); }}>
                    <div className="flex items-center gap-4">
                        <div className="bg-white/20 p-2.5 rounded-xl text-white"><Award size={28} /></div>
                        <div className="min-w-0"><p className="font-bold text-base truncate">Microlearning Essentials</p><p className="text-xs text-blue-200 truncate">ID: {currentUserProfile.cert_micro_id}</p></div>
                    </div>
                    <ChevronRight size={20} className="text-white/60 group-hover:text-white transition-colors shrink-0" />
                    </div>
                ) : (
                    <div className="bg-slate-900 rounded-2xl p-4 border border-slate-800 flex items-center gap-4 opacity-50">
                        <div className="bg-slate-800 p-2.5 rounded-xl text-slate-500"><Lock size={28} /></div>
                        <div><p className="font-bold text-slate-400">Microlearning Essentials</p><p className="text-xs text-slate-600">ยังไม่ได้รับเกียรติบัตร</p></div>
                    </div>
                )}

                {/* Blockchain Certificate */}
                {currentUserProfile.cert_block_id ? (
                    <div className="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-4 shadow-lg border border-white/10 text-white flex items-center justify-between cursor-pointer hover:scale-[1.02] transition-transform group" onClick={() => { setCertType('block'); setShowCertificate(true); }}>
                    <div className="flex items-center gap-4">
                        <div className="bg-white/20 p-2.5 rounded-xl text-white"><Award size={28} /></div>
                        <div className="min-w-0"><p className="font-bold text-base truncate">Blockchain Credentials</p><p className="text-xs text-emerald-200 truncate">ID: {currentUserProfile.cert_block_id}</p></div>
                    </div>
                    <ChevronRight size={20} className="text-white/60 group-hover:text-white transition-colors shrink-0" />
                    </div>
                ) : (
                    <div className="bg-slate-900 rounded-2xl p-4 border border-slate-800 flex items-center gap-4 opacity-50">
                        <div className="bg-slate-800 p-2.5 rounded-xl text-slate-500"><Lock size={28} /></div>
                        <div><p className="font-bold text-slate-400">Blockchain Credentials</p><p className="text-xs text-slate-600">ยังไม่ได้รับเกียรติบัตร</p></div>
                    </div>
                )}
            </div>
        </div>
      </div>
    );
  }
  
  if (isRegistering) {
    if (isLoginMode) {
      return (
        <div className="p-5 pb-10 animate-fade-in flex flex-col justify-center min-h-[80vh] relative z-10 max-w-md mx-auto">
          {/* ปุ่มปิด (X) สำหรับหน้า Login */}
          <div className="absolute top-0 right-0 pt-4 pr-2">
            <button type="button" onClick={() => setIsRegistering(false)} className="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-800 transition-colors">
                <X size={24} />
            </button>
          </div>
          
          <AuthHeader />
          <form onSubmit={handleUserLogin} className="space-y-6 w-full">
            <div className="bg-slate-900/90 backdrop-blur-md rounded-3xl p-8 shadow-2xl border border-slate-700 text-center">
              <h3 className="font-black text-white mb-2 text-xl">เข้าสู่ระบบ</h3>
              <p className="text-slate-400 text-sm mb-6">กรอกเลขบัตรประชาชนเพื่อเข้าใช้งาน</p>
              <div className="text-left"><label htmlFor="login_id_card" className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">เลขบัตรประชาชน</label><div className="relative"><CreditCard className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" size={20} /><input type="text" id="login_id_card" name="login_id_card" required maxLength={13} className="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-800 border-2 border-slate-700 text-white focus:border-blue-500 focus:outline-none transition-colors font-medium placeholder-slate-600" placeholder="1234567890123" /></div></div>
            </div>
            <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-500 hover:shadow-xl hover:shadow-blue-900/20 transition-all active:scale-95">เข้าสู่ระบบ</button>
            <div className="text-center"><button type="button" onClick={() => setIsLoginMode(false)} className="text-slate-400 font-bold text-sm hover:text-white underline-offset-4 hover:underline transition-colors">ยังไม่มีบัญชี? ลงทะเบียนใหม่</button></div>
          </form>
        </div>
      );
    }
    return (
      <div className="p-5 pb-10 animate-fade-in relative z-10 max-w-lg mx-auto">
        <AuthHeader />
        <form onSubmit={handleRegister} className="space-y-6">
          <div className="flex items-center justify-between mb-2 px-2"><h2 className="text-xl font-black text-white">ลงทะเบียนสมาชิกใหม่</h2><button type="button" onClick={() => setIsRegistering(false)} className="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-800 transition-colors"><X size={24} /></button></div>
          {showSuccessMessage ? (
            <div className="bg-emerald-500/10 border-2 border-emerald-500/50 rounded-3xl p-8 text-center animate-bounce-in">
              <div className="bg-emerald-500 text-white rounded-full p-4 w-16 h-16 mx-auto mb-6 flex items-center justify-center shadow-lg shadow-emerald-500/30"><Check size={32} /></div>
              <h3 className="text-2xl font-black text-white mb-2">ลงทะเบียนสำเร็จ!</h3><p className="text-emerald-300 font-medium">ระบบกำลังบันทึกข้อมูลของคุณ...</p>
            </div>
          ) : (
            <>
              <div className="bg-slate-900/90 backdrop-blur-md rounded-3xl p-6 shadow-xl border border-slate-700 space-y-4">
                <h3 className="font-black text-slate-300 mb-4 text-sm uppercase tracking-wider border-b border-slate-800 pb-2">ข้อมูลส่วนตัว</h3>
                <div><label htmlFor="avatar_file" className="block text-xs font-bold text-slate-400 mb-2">รูปโปรไฟล์ (JPG)</label><div className="flex items-center gap-4">{avatarBase64 ? (<img src={avatarBase64} alt="Preview" className="w-16 h-16 rounded-2xl object-cover border-2 border-blue-500 shadow-md" />) : (<div className="w-16 h-16 rounded-2xl bg-slate-800 flex items-center justify-center border-2 border-dashed border-slate-600 text-slate-500"><ImageIcon size={24} /></div>)}<div className="flex-1"><input type="file" id="avatar_file" accept="image/jpeg, image/jpg" onChange={handleFileChange} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-500 transition-all cursor-pointer" /></div></div></div>
                <div className="grid grid-cols-1 gap-4">
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">ชื่อ-นามสกุล *</label><input type="text" name="full_name" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="ชื่อ นามสกุล" /></div>
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">เลขบัตรประชาชน (13 หลัก) *</label><input type="text" name="id_card" required maxLength={13} className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="xxxxxxxxxxxxx" /></div>
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">อีเมล *</label><input type="email" name="email" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="email@example.com" /></div>
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">เบอร์โทรศัพท์ *</label><input type="tel" name="phone" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="08x-xxx-xxxx" /></div>
                </div>
              </div>
              <div className="bg-slate-900/90 backdrop-blur-md rounded-3xl p-6 shadow-xl border border-slate-700 space-y-4">
                <h3 className="font-black text-slate-300 mb-4 text-sm uppercase tracking-wider border-b border-slate-800 pb-2">ข้อมูลวิชาการ</h3>
                <div className="grid grid-cols-1 gap-4">
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">สถาบัน/หน่วยงาน *</label><input type="text" name="institution" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="ชื่อสถาบัน" /></div>
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">คณะ/ภาควิชา *</label><input type="text" name="department" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="ระบุภาควิชา" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-xs font-bold text-slate-400 mb-1">ตำแหน่ง *</label><select name="position" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none"><option value="">เลือก...</option><option value="นักเรียน/นักศึกษา">นักเรียน/นักศึกษา</option><option value="ครู/อาจารย์">ครู/อาจารย์</option><option value="บุคคลทั่วไป">บุคคลทั่วไป</option></select></div>
                        <div><label className="block text-xs font-bold text-slate-400 mb-1">วุฒิการศึกษา *</label><select name="academic_rank" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none"><option value="">เลือก...</option><option value="ต่ำกว่าปริญญาตรี">ต่ำกว่า ป.ตรี</option><option value="ปริญญาตรี">ปริญญาตรี</option><option value="ปริญญาโท">ปริญญาโท</option><option value="ปริญญาเอก">ปริญญาเอก</option></select></div>
                    </div>
                    <div><label className="block text-xs font-bold text-slate-400 mb-1">ความเชี่ยวชาญ *</label><input type="text" name="expertise" required className="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white focus:border-blue-500 focus:outline-none" placeholder="เช่น คอมพิวเตอร์, การสอน" /></div>
                </div>
              </div>
              <button type="submit" disabled={isLoading} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-2xl font-black text-lg hover:shadow-lg hover:shadow-blue-900/50 transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed transform active:scale-95">
                {isLoading ? <><Loader2 className="animate-spin" size={24} /><span>กำลังบันทึกข้อมูล...</span></> : <><CheckCircle size={24} /><span>ยืนยันการลงทะเบียน</span></>}
              </button>
              <div className="text-center mt-2"><button type="button" onClick={() => setIsLoginMode(true)} className="text-slate-400 font-bold text-sm hover:text-white underline-offset-4 hover:underline transition-colors">เคยลงทะเบียนแล้ว? เข้าสู่ระบบ</button></div>
            </>
          )}
        </form>
      </div>
    );
  }
  return (
    <div className="p-5 pb-32 space-y-6 animate-fade-in relative z-10 max-w-4xl mx-auto">
      <div className="flex justify-between items-center">
        <div>
             <h2 className="text-2xl font-black text-white">ผู้ลงทะเบียน</h2>
             <p className="text-slate-400 text-sm">รายชื่อผู้เข้าร่วมอบรมทั้งหมด</p>
        </div>
        <button onClick={() => setIsRegistering(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center gap-2 active:scale-95"><UserPlus size={18} /><span>ลงทะเบียน</span></button>
      </div>
       
      {/* Public View: Only show count/stats, no list */}
       <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-xl border border-slate-700"><div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:divide-x md:divide-slate-700"><div className="text-center pb-4 md:pb-0 border-b md:border-b-0 border-slate-700"><p className="text-3xl font-black text-blue-400">{profiles.length}</p><p className="text-xs font-bold text-slate-400 mt-1">ผู้ลงทะเบียน</p></div><div className="text-center pb-4 md:pb-0 border-b md:border-b-0 border-slate-700"><p className="text-3xl font-black text-emerald-400">{new Set(profiles.map(p => p.institution)).size}</p><p className="text-xs font-bold text-slate-400 mt-1">หน่วยงาน</p></div><div className="text-center"><p className="text-3xl font-black text-purple-400">{profiles.filter(p => p.cert_micro_id || p.cert_block_id).length}</p><p className="text-xs font-bold text-slate-400 mt-1">จบหลักสูตร</p></div></div></div>
       
      <div className="flex flex-col items-center justify-center p-10 text-center space-y-4 opacity-50">
        <User size={48} className="text-slate-600" />
        <p className="text-slate-500 font-medium">รายการผู้ลงทะเบียนสงวนสิทธิ์สำหรับผู้ดูแลระบบ</p>
      </div>
    </div>
  );
};

const VerifyView = ({ certificates }) => {
  const [searchId, setSearchId] = useState('');
  const [result, setResult] = useState(null);
  const [hasSearched, setHasSearched] = useState(false);
  const handleVerify = (e) => { e.preventDefault(); const found = certificates.find(c => c.certificateId === searchId.trim()); setResult(found || null); setHasSearched(true); };
  return (
    <div className="p-5 pb-32 space-y-6 animate-fade-in relative z-10 max-w-3xl mx-auto">
      <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden border border-slate-700">
        <div className="absolute top-0 right-0 p-6 opacity-10"><FileCheck size={120} /></div>
        <h2 className="text-2xl font-black mb-2 relative z-10">ตรวจสอบเกียรติบัตร</h2>
        <p className="text-slate-400 text-sm mb-6 relative z-10 font-medium">สำหรับนายจ้างหรือหน่วยงานที่ต้องการตรวจสอบความถูกต้องของเอกสาร</p>
        <form onSubmit={handleVerify} className="relative z-10">
          <div className="flex flex-col md:flex-row gap-2">
            <div className="flex-1 relative">
                <input type="text" value={searchId} onChange={(e) => setSearchId(e.target.value)} placeholder="กรอกรหัสอ้างอิง (เช่น CERT-X1Y2Z3)" className="w-full bg-slate-950 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 font-mono" />
                <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500" size={18} />
            </div>
            <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all">ตรวจสอบ</button>
          </div>
        </form>
      </div>
      {hasSearched && (
        <div className="animate-fade-in">
          {result ? (
            <div className="bg-slate-900 rounded-2xl p-6 shadow-md border-l-4 border-green-500">
              <div className="flex items-start gap-4"><div className="bg-green-100 p-3 rounded-full text-green-600 shrink-0"><CheckCircle size={32} /></div><div><h3 className="text-green-700 font-black text-lg mb-1">เอกสารถูกต้อง</h3><div className="space-y-1 text-sm text-slate-300"><p><span className="font-bold text-slate-500">ชื่อผู้เรียน:</span> {result.studentName}</p><p><span className="font-bold text-slate-500">หลักสูตร:</span> {result.courseTitle}</p><p><span className="font-bold text-slate-500">รหัสเอกสาร:</span> {result.certificateId}</p><p><span className="font-bold text-slate-500">วันที่ออก:</span> {new Date(result.issuedAt?.seconds * 1000).toLocaleDateString('th-TH')}</p></div></div></div>
            </div>
          ) : (
            <div className="bg-white rounded-2xl p-6 shadow-md border-l-4 border-red-500 border-t border-r border-b border-slate-700"><div className="flex items-center gap-4"><div className="bg-red-500/20 p-3 rounded-full text-red-500 shrink-0"><AlertCircle size={32} /></div><div><h3 className="text-red-400 font-black text-lg mb-1">ไม่พบข้อมูล</h3><p className="text-sm text-gray-500">รหัสเอกสารไม่ถูกต้อง หรือยังไม่มีในระบบ</p></div></div></div>
          )}
        </div>
      )}
    </div>
  );
};

const AdminView = ({ isAdminLoggedIn, setIsAdminLoggedIn, showToast, profiles, handleDeleteProfile, isLoading, googleScriptUrl, setGoogleScriptUrl }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [expiryModalUser, setExpiryModalUser] = useState(null);
  const [inputScriptUrl, setInputScriptUrl] = useState(googleScriptUrl);
  const [isSavingUrl, setIsSavingUrl] = useState(false);

  const handleLogin = (e) => {
    e.preventDefault();
    if (username === 'admin' && password === 'admin1234') { setIsAdminLoggedIn(true); showToast('เข้าสู่ระบบผู้ดูแลระบบสำเร็จ', 'success'); } else { showToast('ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง', 'error'); }
  };
  const handleLogout = () => { setIsAdminLoggedIn(false); setUsername(''); setPassword(''); };
   
  const handleSaveExpiry = async (date) => {
    if (!expiryModalUser) return;
    try {
        const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', expiryModalUser.id);
        const updateData = { access_expiry: date ? new Date(date) : null }; // If null, remove limit
        await updateDoc(profileRef, updateData);
        setExpiryModalUser(null);
    } catch (error) {
        console.error(error);
        showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
    }
  };
  
  const handleSaveScriptUrl = () => {
      setIsSavingUrl(true);
      setGoogleScriptUrl(inputScriptUrl);
      localStorage.setItem('google_script_url', inputScriptUrl);
      setTimeout(() => {
          setIsSavingUrl(false);
          showToast('บันทึก URL ของ Google Script แล้ว', 'success');
      }, 500);
  };

  if (!isAdminLoggedIn) {
    return (
      <div className="p-5 flex flex-col items-center justify-center h-[80vh] animate-fade-in relative z-10">
        <div className="bg-slate-900/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-slate-700">
          <div className="text-center mb-6"><div className="bg-slate-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400"><Lock size={32} /></div><h2 className="text-2xl font-black text-white">ผู้ดูแลระบบ</h2><p className="text-slate-500 text-sm">กรุณาเข้าสู่ระบบเพื่อจัดการข้อมูล</p></div>
          <form onSubmit={handleLogin} className="space-y-4">
            <div><label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Username</label><div className="relative"><User className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={18} /><input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-950 border border-slate-700 text-white focus:border-blue-500 focus:outline-none transition-colors font-medium" placeholder="Username" /></div></div>
            <div><label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Password</label><div className="relative"><Key className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={18} /><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-950 border border-slate-700 text-white focus:border-blue-500 focus:outline-none transition-colors font-medium" placeholder="Password" /></div></div>
            <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-500 transition-colors shadow-lg">เข้าสู่ระบบ</button>
          </form>
        </div>
      </div>
    );
  }
  return (
    <div className="p-5 pb-32 animate-fade-in relative z-10 max-w-7xl mx-auto">
      {expiryModalUser && <ExpiryModal user={expiryModalUser} onClose={() => setExpiryModalUser(null)} onSave={handleSaveExpiry} />}
      <div className="flex justify-between items-center mb-6"><div><h2 className="text-2xl font-black text-white">จัดการข้อมูลผู้เรียน</h2><p className="text-sm text-slate-400">Admin Dashboard</p></div><button onClick={handleLogout} className="text-red-400 bg-red-900/20 hover:bg-red-900/40 px-4 py-2 rounded-xl font-bold text-sm transition-colors flex items-center gap-2 border border-red-900/30"><LogOut size={18} /><span>ออกจากระบบ</span></button></div>
      
      {/* Google Sheet Config Section */}
      <div className="bg-slate-900 rounded-2xl shadow-sm border border-slate-700 p-6 mb-6">
          <h3 className="text-white font-bold text-lg mb-4 flex items-center gap-2"><Settings size={20} className="text-emerald-400"/> ตั้งค่าการเชื่อมต่อ Google Sheets</h3>
          <div className="flex flex-col gap-2">
              <label className="text-xs text-slate-400 font-bold ml-1">Google Sheets Web App URL</label>
              <div className="flex flex-col md:flex-row gap-2">
                  <div className="relative flex-1">
                      <LinkIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
                      <input 
                        type="text" 
                        value={inputScriptUrl} 
                        onChange={(e) => setInputScriptUrl(e.target.value)} 
                        className="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-950 border border-slate-600 text-white focus:border-emerald-500 focus:outline-none transition-colors text-sm font-mono"
                        placeholder="https://script.google.com/macros/s/..."
                      />
                  </div>
                  <button onClick={handleSaveScriptUrl} disabled={isSavingUrl} className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 md:py-0 rounded-xl font-bold transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                      {isSavingUrl ? <Loader2 className="animate-spin" size={18} /> : <Save size={18} />} 
                      บันทึก
                  </button>
              </div>
              <p className="text-xs text-slate-500 mt-2">
                  * นำ URL ที่ได้จากการ Deploy Google Apps Script (Web App) มาใส่ที่นี่ เพื่อให้ระบบส่งข้อมูลผู้ลงทะเบียนไปยัง Google Sheets โดยอัตโนมัติ
              </p>
          </div>
      </div>

      <div className="bg-slate-900 rounded-2xl shadow-sm border border-slate-700 overflow-hidden">
        <div className="p-4 border-b border-slate-800 bg-slate-800/50 flex justify-between items-center"><span className="font-bold text-slate-300">รายการลงทะเบียนทั้งหมด ({profiles.length})</span><button className="text-xs font-bold text-violet-400 hover:text-violet-300 bg-slate-900 border border-slate-600 px-3 py-1 rounded-lg">Export CSV</button></div>
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse min-w-[800px]">
            <thead><tr className="text-xs font-bold text-slate-500 border-b border-slate-800 bg-slate-900"><th className="p-4">ผู้เรียน</th><th className="p-4">การติดต่อ</th><th className="p-4">สถานะ/ตำแหน่ง</th><th className="p-4 text-right">หมดอายุ</th><th className="p-4 text-center">จัดการ</th></tr></thead>
            <tbody className="text-sm">
              {profiles.length === 0 ? (<tr><td colSpan="5" className="p-8 text-center text-slate-500">ไม่มีข้อมูลผู้ลงทะเบียน</td></tr>) : (
                profiles.map((profile) => (
                  <tr key={profile.id} className="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                    <td className="p-4"><div className="flex items-center gap-3"><img src={profile.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.full_name)}&background=random`} alt="" className="w-10 h-10 rounded-full bg-slate-700 object-cover" /><div><p className="font-bold text-white">{profile.full_name}</p><p className="text-xs text-slate-400">{profile.institution}</p><p className="text-xs text-slate-500 mt-1 flex items-center gap-1"><CreditCard size={10} /> ID: {profile.id_card}</p></div></div></td>
                    <td className="p-4"><p className="text-slate-300">{profile.email}</p><p className="text-xs text-slate-500">{profile.phone}</p></td>
                    <td className="p-4"><span className="inline-block bg-blue-900/30 text-blue-400 px-2 py-1 rounded-md text-xs font-bold border border-blue-800/50">{profile.position}</span><p className="text-xs text-slate-500 mt-1">{profile.department}</p></td>
                    <td className="p-4 text-right">
                      {profile.access_expiry ? (
                          <div className="text-xs text-orange-400 font-mono font-bold flex items-center justify-end gap-1">
                             <Clock size={12}/>
                             {new Date(profile.access_expiry.seconds * 1000).toLocaleDateString('th-TH')}
                          </div>
                      ) : <span className="text-xs text-slate-600">- ไม่จำกัด -</span>}
                    </td>
                    <td className="p-4 text-center">
                      <div className="flex justify-center gap-2">
                        <button onClick={() => setExpiryModalUser(profile)} title="ตั้งเวลาหมดอายุ" className="text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 p-2 rounded-lg transition-all"><Clock size={20} /></button>
                        <button onClick={() => handleDeleteProfile(profile.id)} disabled={isLoading} title="ลบผู้ใช้" className="text-red-400 hover:text-red-300 hover:bg-red-900/20 p-2 rounded-lg transition-all"><Trash2 size={20} /></button>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

// --- Main App Component ---

export default function App() {
  
  const [activeTab, setActiveTab] = useState('learn');
  const [user, setUser] = useState(null);
  const [profiles, setProfiles] = useState([]);
  const [certificates, setCertificates] = useState([]);
  const [completedModules, setCompletedModules] = useState([]);
  const [confettiPieces, setConfettiPieces] = useState([]);
  const [toast, setToast] = useState(null);
  const [showCertificate, setShowCertificate] = useState(false);
  const [certType, setCertType] = useState(null);
  const [isProfileLoading, setIsProfileLoading] = useState(true);
  const [viewingModule, setViewingModule] = useState(null);
  const [activeQuizModule, setActiveQuizModule] = useState(null);
  const [rewardModalData, setRewardModalData] = useState(null);
  const [isRegistering, setIsRegistering] = useState(false);
  const [isLoginMode, setIsLoginMode] = useState(false); 
  const [isLoading, setIsLoading] = useState(false);
  const [showSuccessMessage, setShowSuccessMessage] = useState(false);
  const [avatarBase64, setAvatarBase64] = useState(null);
  const [manualLoginId, setManualLoginId] = useState(null);
  const [explicitLogout, setExplicitLogout] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [chatInitialQuery, setChatInitialQuery] = useState('');
  const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
  const [now, setNow] = useState(new Date());
  
  // Google Script URL State
  const [googleScriptUrl, setGoogleScriptUrl] = useState(localStorage.getItem('google_script_url') || '');

  // Timer Effect - Runs every second for real-time validation
  useEffect(() => {
    const timer = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  // Auth Effect
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    script.async = true;
    document.body.appendChild(script);
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
      else await signInAnonymously(auth);
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => { unsubscribe(); if(document.body.contains(script)) document.body.removeChild(script); };
  }, []);

  // Data Loading Effect
  useEffect(() => {
    if (!user) return;
    const qProfiles = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'));
    const unsubProfiles = onSnapshot(qProfiles, (snapshot) => {
      const loadedProfiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.registered_at?.seconds || 0) - (a.registered_at?.seconds || 0));
      setProfiles(loadedProfiles);
      setIsProfileLoading(false);
    });
    const qCerts = query(collection(db, 'artifacts', appId, 'public', 'data', 'certificates'));
    const unsubCerts = onSnapshot(qCerts, (snapshot) => {
      const loadedCerts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setCertificates(loadedCerts);
    });
    return () => { unsubProfiles(); unsubCerts(); };
  }, [user]);

  // Persistence Effect
  useEffect(() => {
    if (profiles.length > 0 && !manualLoginId && !explicitLogout) {
      const lastId = localStorage.getItem('last_login_id');
      if (lastId) setManualLoginId(lastId);
    }
  }, [profiles, manualLoginId, explicitLogout]);

  // Derived State
  const currentUserProfile = !explicitLogout 
    ? (manualLoginId ? profiles.find(p => p.id_card === manualLoginId) : profiles.find(p => p.createdBy === user?.uid)) 
    : null;
  const isRegistered = !!currentUserProfile;

  // Real-time Expiry Logic
  const expiryDate = currentUserProfile?.access_expiry ? new Date(currentUserProfile.access_expiry.seconds * 1000) : null;
  const timeLeft = expiryDate ? expiryDate.getTime() - now.getTime() : null;
  const isAccessExpired = timeLeft !== null && timeLeft <= 0;
  // Warning Phase: Last 5 minutes (300,000 ms)
  const isWarningPhase = timeLeft !== null && timeLeft > 0 && timeLeft <= 300000;

  // Helper to format remaining time
  const formatTimeLeft = (ms) => {
    if (!ms || ms < 0) return "0:00";
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  // Sync Progress Effect
  useEffect(() => {
    if (currentUserProfile?.completed_modules && currentUserProfile.completed_modules.length !== completedModules.length) {
      setCompletedModules(currentUserProfile.completed_modules);
    }
  }, [currentUserProfile]);

  const totalXP = (currentUserProfile?.xp || 0);

  // --- Handlers ---
  const handleGoToRegister = () => { setActiveTab('profile'); setIsRegistering(true); setIsLoginMode(false); };
  const handleUserLogout = () => { 
    setManualLoginId(null); 
    setExplicitLogout(true); 
    setIsRegistering(false); 
    setCompletedModules([]); 
    localStorage.removeItem('last_login_id'); 
    showToast('ออกจากระบบเรียบร้อยแล้ว', 'success'); 
  };
  const showToast = (message, type = 'success') => { setToast({ message, type }); };
  const triggerConfetti = () => {
    const colors = ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'];
    const pieces = Array.from({ length: 80 }).map((_, i) => ({ id: i, color: colors[Math.floor(Math.random() * colors.length)], left: Math.random() * 100, animationDuration: Math.random() * 2 + 2, animationDelay: Math.random() * 0.5 }));
    setConfettiPieces(pieces);
    setTimeout(() => setConfettiPieces([]), 4500);
  };
  const openModuleVideo = (module) => { setViewingModule(module); };
  const closeModuleVideo = () => { setViewingModule(null); };
  const handleVideoFinish = (module) => {
    if (completedModules.includes(module.id)) {
      closeModuleVideo();
      if (window.confirm("คุณเรียนบทเรียนนี้ผ่านแล้ว ต้องการทำแบบทดสอบอีกครั้งหรือไม่?")) setActiveQuizModule(module);
    } else {
      closeModuleVideo();
      setActiveQuizModule(module);
    }
  };
   
  const issueCertificate = async (type) => {
    if (!currentUserProfile) return;
    const certField = type === 'micro' ? 'cert_micro_id' : 'cert_block_id';
    const dateField = type === 'micro' ? 'cert_micro_date' : 'cert_block_date';
     
    // Check if already has THIS specific cert
    if (currentUserProfile[certField]) return;

    // NEW ID GENERATION LOGIC: EDO-[Course][Year][Month]-[Random]
    const prefix = type === 'micro' ? 'MC' : 'BC';
    const date = new Date();
    const thaiYear = (date.getFullYear() + 543).toString().slice(-2); // 2569 -> 69
    const month = (date.getMonth() + 1).toString().padStart(2, '0'); // 1 -> 01
     
    // Generate Random 6 char alphanumeric uppercase
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let randomSuffix = '';
    for (let i = 0; i < 6; i++) {
      randomSuffix += chars.charAt(Math.floor(Math.random() * chars.length));
    }
     
    const certId = `EDO-${prefix}${thaiYear}${month}-${randomSuffix}`;
     
    const courseTitle = type === 'micro' ? defaultConfig.micro_course_title : defaultConfig.block_course_title;
     
    const certData = { 
        userId: user?.uid || 'manual', 
        studentName: currentUserProfile.full_name, 
        courseTitle: courseTitle, 
        certificateId: certId, 
        type: type,
        issuedAt: serverTimestamp(), 
        avatar_url: currentUserProfile.avatar_url 
    };
     
    try { 
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'certificates'), certData);
      
      // Update User Profile
      if (currentUserProfile.id) {
          const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUserProfile.id);
          const updateData = {};
          updateData[certField] = certId;
          updateData[dateField] = serverTimestamp();
          
          await updateDoc(profileRef, updateData);
      }
    } catch (error) { console.error("Error issuing certificate:", error); }
  };

  const handleQuizPass = async () => {
    if (activeQuizModule && !completedModules.includes(activeQuizModule.id)) {
      const newModuleId = activeQuizModule.id;
      const rewardXP = activeQuizModule.reward.xp;
      
      // Update Local State
      const nextModules = [...completedModules, newModuleId];
      setCompletedModules(nextModules);
      setRewardModalData(activeQuizModule.reward);
      triggerConfetti();

      // Update Firestore
      if (currentUserProfile?.id) {
         try {
             const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUserProfile.id);
             const currentModules = currentUserProfile.completed_modules || [];
             const currentXP = currentUserProfile.xp || 0;
             await updateDoc(profileRef, { completed_modules: [...currentModules, newModuleId], xp: currentXP + rewardXP });
         } catch (err) { console.error("Error updating progress:", err); }
      }
      
      // Check for Module Completion and Issue Specific Certificate
      const microIds = [1, 2, 3];
      const blockIds = [4, 5];
      
      const isMicroDone = microIds.every(id => nextModules.includes(id));
      const isBlockDone = blockIds.every(id => nextModules.includes(id));
      
      if (isMicroDone && !currentUserProfile?.cert_micro_id) {
          issueCertificate('micro');
      }
      
      if (isBlockDone && !currentUserProfile?.cert_block_id) {
          issueCertificate('block');
      }
    }
    setActiveQuizModule(null); 
  };
   
  const handleAskAIAboutModule = (module) => { setChatInitialQuery(`สรุปเนื้อหา ${module.title}`); setIsChatOpen(true); setViewingModule(null); };
  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.type !== "image/jpeg" && file.type !== "image/jpg") { showToast('กรุณาเลือกไฟล์รูปภาพ JPG เท่านั้น', 'error'); e.target.value = null; return; }
      const reader = new FileReader();
      reader.onload = (readerEvent) => {
         const image = new Image();
         image.onload = () => {
             const canvas = document.createElement('canvas');
             const MAX_WIDTH = 150; const MAX_HEIGHT = 150;
             let width = image.width; let height = image.height;
             if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
             canvas.width = width; canvas.height = height;
             const ctx = canvas.getContext('2d');
             ctx.drawImage(image, 0, 0, width, height);
             const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
             setAvatarBase64(dataUrl);
         };
         image.src = readerEvent.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const sendToGoogleSheet = async (data) => {
      // 1. ตรวจสอบว่ารันอยู่บน Google Apps Script หรือไม่ (Hybrid Support)
      if (window.google && window.google.script && window.google.script.run) {
          console.log("Sending via google.script.run...");
          window.google.script.run
            .withSuccessHandler(() => console.log("Saved to Sheets via GAS"))
            .withFailureHandler((err) => console.error("GAS Error:", err))
            .saveProfile(data); // เรียกฟังก์ชัน saveProfile ใน Code.gs
          return;
      }

      // 2. ถ้าไม่ใช่ ให้ใช้ fetch (Form Submit) ไปยัง Web App URL
      if (!googleScriptUrl) return;
      try {
          console.log("Sending via fetch...");
          await fetch(googleScriptUrl, {
              method: 'POST',
              mode: 'no-cors', // จำเป็นสำหรับ Google Apps Script Web App
              headers: {
                  'Content-Type': 'text/plain;charset=utf-8',
              },
              body: JSON.stringify(data)
          });
          console.log("Sent request to Google Sheets endpoint");
      } catch (error) {
          console.error("Error sending to Google Sheet:", error);
      }
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    if (!user) return;
    if (profiles.length >= 999) { showToast('ถึงขีดจำกัดการลงทะเบียน', 'error'); return; }
    const formData = new FormData(e.target);
    if (profiles.some(p => p.id_card === formData.get('id_card'))) { showToast('เลขบัตรประชาชนนี้ลงทะเบียนแล้ว กรุณาเข้าสู่ระบบ', 'error'); return; }
    setIsLoading(true);
    const fullName = formData.get('full_name');
    const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=random&color=fff&size=128`;
    const finalAvatarUrl = avatarBase64 || defaultAvatar;
    
    const profileData = { 
        full_name: fullName, 
        id_card: formData.get('id_card'), 
        email: formData.get('email'), 
        phone: formData.get('phone'), 
        avatar_url: finalAvatarUrl, 
        institution: formData.get('institution'), 
        department: formData.get('department'), 
        position: formData.get('position'), 
        academic_rank: formData.get('academic_rank'), 
        expertise: formData.get('expertise'), 
        registered_at: serverTimestamp(), 
        createdBy: user.uid, 
        completed_modules: [], 
        xp: 0
    };
    
    // Client-side data object for Google Sheets (no firestore timestamps)
    const sheetData = {
        ...profileData,
        registered_at: new Date().toISOString()
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), profileData);
      
      // Attempt to save to Google Sheet if configured
      if (googleScriptUrl) {
          sendToGoogleSheet(sheetData);
      }

      setShowSuccessMessage(true);
      setExplicitLogout(false);
      localStorage.setItem('last_login_id', formData.get('id_card')); 
      setTimeout(() => { setShowSuccessMessage(false); setIsRegistering(false); setAvatarBase64(null); }, 2000);
    } catch (error) { showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error'); } finally { setIsLoading(false); }
  };
  const handleUserLogin = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const loginIdCard = formData.get('login_id_card');
    if (!loginIdCard) { showToast('กรุณากรอกเลขบัตรประชาชน', 'error'); return; }
    const foundProfile = profiles.find(p => p.id_card === loginIdCard);
    if (foundProfile) {
      setManualLoginId(loginIdCard); setExplicitLogout(false);
      localStorage.setItem('last_login_id', loginIdCard); 
      showToast(`ยินดีต้อนรับกลับ คุณ ${foundProfile.full_name}`, 'success');
      setIsRegistering(false); setActiveTab('learn');
    } else { showToast('ไม่พบข้อมูลผู้ลงทะเบียนนี้', 'error'); }
  };
  const handleDeleteProfile = async (id) => {
    if (!user) return;
    setIsLoading(true);
    try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', id)); showToast('ลบข้อมูลเรียบร้อยแล้ว', 'success'); } catch (error) { showToast('เกิดข้อผิดพลาดในการลบข้อมูล', 'error'); } finally { setIsLoading(false); }
  };

  const downloadCertificate = async () => {
    if (!window.html2canvas) { showToast("ระบบกำลังโหลดเครื่องมือ", "error"); return; }
    const element = document.getElementById('certificate-capture');
    if (element) {
      try {
        const canvas = await window.html2canvas(element, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: "#ffffff",
            logging: false,
            allowTaint: true,
            imageTimeout: 0
        });
        const link = document.createElement('a');
        link.download = `Certificate.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
        showToast("บันทึกเกียรติบัตรสำเร็จ", "success");
      } catch (err) { 
          console.error("Certificate Download Error:", err);
          showToast("เกิดข้อผิดพลาดในการบันทึกภาพ โปรดลองใหม่อีกครั้ง", "error"); 
      }
    }
  };

  return (
    <div className="h-full w-full flex flex-col font-sans relative" style={{ backgroundColor: defaultConfig.background_color }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&family=Sarabun:wght@400;700&family=Great+Vibes&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #020617; }
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .pulse-animation { animation: pulse-ring 2s infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounceIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        /* Animated Background */
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
      `}</style>
      
      {showCertificate && <CertificateModal profile={currentUserProfile} type={certType} onClose={() => setShowCertificate(false)} onDownload={downloadCertificate} />}
      {rewardModalData && <RewardModal reward={rewardModalData} onClose={() => setRewardModalData(null)} />}
      {activeQuizModule && <QuizModal module={activeQuizModule} onClose={() => setActiveQuizModule(null)} onPass={handleQuizPass} />}
      {viewingModule && <VideoModal module={viewingModule} onClose={closeModuleVideo} onVideoFinish={handleVideoFinish} onAskAI={handleAskAIAboutModule} />}
      <AIChatWindow isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} initialQuery={chatInitialQuery} onClear={() => setChatInitialQuery('')} />
      {!isChatOpen && <button onClick={() => setIsChatOpen(true)} className="fixed bottom-24 right-4 bg-blue-600 text-white p-4 rounded-full shadow-xl shadow-blue-900/50 hover:bg-blue-500 hover:scale-110 transition-all z-[150] group"><MessageCircle size={28} /><span className="absolute right-0 top-0 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span></span><div className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-slate-700">ถาม AI ได้นะ!</div></button>}
      {confettiPieces.map(piece => <ConfettiPiece key={piece.id} {...piece} />)}
      {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

      <div className="flex-1 overflow-y-auto overflow-x-hidden relative z-10 w-full">
        {/* Warning Banner */}
        {isWarningPhase && !isAccessExpired && !isAdminLoggedIn && (
           <div className="bg-orange-500 text-white p-3 text-center text-sm font-bold shadow-lg animate-pulse flex items-center justify-center gap-2 sticky top-0 z-[50]">
              <Clock size={18} className="text-white" />
              <span>⏳ เหลือเวลาใช้งานอีก {formatTimeLeft(timeLeft)} นาที</span>
           </div>
        )}

        {activeTab === 'learn' && <LearnView isProfileLoading={isProfileLoading} isRegistered={isRegistered} handleGoToRegister={handleGoToRegister} completedModules={completedModules} openModuleVideo={openModuleVideo} setShowCertificate={setShowCertificate} currentUserProfile={currentUserProfile} setCertType={setCertType} isAccessExpired={isAccessExpired} issueCertificate={issueCertificate} onOpenQuiz={setActiveQuizModule} />}
        {activeTab === 'wallet' && <WalletView isProfileLoading={isProfileLoading} isRegistered={isRegistered} handleGoToRegister={handleGoToRegister} totalXP={totalXP} completedModules={completedModules} />}
        {activeTab === 'profile' && <ProfileView isRegistered={isRegistered} currentUserProfile={currentUserProfile} handleUserLogout={handleUserLogout} isRegistering={isRegistering} isLoginMode={isLoginMode} handleUserLogin={handleUserLogin} setIsLoginMode={setIsLoginMode} setIsRegistering={setIsRegistering} handleRegister={handleRegister} showSuccessMessage={showSuccessMessage} avatarBase64={avatarBase64} handleFileChange={handleFileChange} isLoading={isLoading} profiles={profiles} handleDeleteProfile={handleDeleteProfile} setShowCertificate={setShowCertificate} setCertType={setCertType} />}
        {activeTab === 'verify' && <VerifyView certificates={certificates} />}
        {activeTab === 'admin' && <AdminView isAdminLoggedIn={isAdminLoggedIn} setIsAdminLoggedIn={setIsAdminLoggedIn} showToast={showToast} profiles={profiles} handleDeleteProfile={handleDeleteProfile} isLoading={isLoading} googleScriptUrl={googleScriptUrl} setGoogleScriptUrl={setGoogleScriptUrl} />}
      </div>

      {/* Navigation Bar - Hidden when Registering/Login */}
      {!isRegistering && (
        <div className="fixed bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-xl border-t border-slate-800 shadow-2xl h-20 z-[100] md:w-auto md:fixed md:bottom-6 md:left-1/2 md:-translate-x-1/2 md:rounded-full md:border md:bg-slate-900/90 md:px-6 md:h-16 md:shadow-[0_0_20px_rgba(0,0,0,0.5)]">
          <div className="h-full flex items-center justify-around px-4 md:gap-8">
            <button onClick={() => setActiveTab('learn')} className={`flex flex-col items-center justify-center flex-1 h-full transition-all duration-300 md:flex-none ${activeTab === 'learn' ? 'text-blue-400 scale-110 -translate-y-1' : 'text-slate-500 hover:text-slate-300'}`}><div className={`p-2 rounded-2xl transition-all ${activeTab === 'learn' ? 'bg-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : ''}`}><BookOpen size={24} strokeWidth={activeTab === 'learn' ? 2.5 : 2} /></div><span className={`text-[10px] font-bold mt-1 transition-opacity md:hidden ${activeTab === 'learn' ? 'opacity-100' : 'opacity-0'}`}>Learn</span></button>
            <button onClick={() => setActiveTab('wallet')} className={`flex flex-col items-center justify-center flex-1 h-full transition-all duration-300 md:flex-none ${activeTab === 'wallet' ? 'text-blue-400 scale-110 -translate-y-1' : 'text-slate-500 hover:text-slate-300'}`}><div className={`p-2 rounded-2xl transition-all ${activeTab === 'wallet' ? 'bg-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : ''}`}><Shield size={24} strokeWidth={activeTab === 'wallet' ? 2.5 : 2} /></div><span className={`text-[10px] font-bold mt-1 transition-opacity md:hidden ${activeTab === 'wallet' ? 'opacity-100' : 'opacity-0'}`}>Wallet</span></button>
            <button onClick={() => setActiveTab('profile')} className={`flex flex-col items-center justify-center flex-1 h-full transition-all duration-300 md:flex-none ${activeTab === 'profile' ? 'text-blue-400 scale-110 -translate-y-1' : 'text-slate-500 hover:text-slate-300'}`}><div className={`p-2 rounded-2xl transition-all ${activeTab === 'profile' ? 'bg-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : ''}`}><User size={24} strokeWidth={activeTab === 'profile' ? 2.5 : 2} /></div><span className={`text-[10px] font-bold mt-1 transition-opacity md:hidden ${activeTab === 'profile' ? 'opacity-100' : 'opacity-0'}`}>Profile</span></button>
            <button onClick={() => setActiveTab('verify')} className={`flex flex-col items-center justify-center flex-1 h-full transition-all duration-300 md:flex-none ${activeTab === 'verify' ? 'text-blue-400 scale-110 -translate-y-1' : 'text-slate-500 hover:text-slate-300'}`}><div className={`p-2 rounded-2xl transition-all ${activeTab === 'verify' ? 'bg-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : ''}`}><FileCheck size={24} strokeWidth={activeTab === 'verify' ? 2.5 : 2} /></div><span className={`text-[10px] font-bold mt-1 transition-opacity md:hidden ${activeTab === 'verify' ? 'opacity-100' : 'opacity-0'}`}>Verify</span></button>
            <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center justify-center flex-1 h-full transition-all duration-300 md:flex-none ${activeTab === 'admin' ? 'text-blue-400 scale-110 -translate-y-1' : 'text-slate-500 hover:text-slate-300'}`}><div className={`p-2 rounded-2xl transition-all ${activeTab === 'admin' ? 'bg-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.3)]' : ''}`}><LayoutDashboard size={24} strokeWidth={activeTab === 'admin' ? 2.5 : 2} /></div><span className={`text-[10px] font-bold mt-1 transition-opacity md:hidden ${activeTab === 'admin' ? 'opacity-100' : 'opacity-0'}`}>Admin</span></button>
          </div>
        </div>
      )}
    </div>
  );
}